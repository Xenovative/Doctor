<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫生資料庫 - AI醫生配對系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='admin-mobile.css') }}" rel="stylesheet">
    <style>
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            border-radius: 8px;
            margin: 0.2rem 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        .db-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 5px;
        }
        .doctor-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .doctor-card:hover {
            transform: translateY(-2px);
        }
        .specialty-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        .search-filters {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .btn-view-mode {
            border-radius: 20px;
            margin: 0 5px;
        }
        .btn-view-mode.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .modal-loading .spinner-border {
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Mobile Navigation Toggle -->
    <button class="mobile-nav-toggle" id="mobileNavToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div class="mt-3">
                <h5>載入醫生資料中...</h5>
                <p class="text-muted">請稍候</p>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar" id="adminSidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h5 class="text-white">
                            <i class="fas fa-user-md me-2"></i>AI醫生配對系統
                        </h5>
                        <small class="text-white-50">管理後台</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                                <i class="fas fa-tachometer-alt me-2"></i>儀表板
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_analytics') }}">
                                <i class="fas fa-chart-bar me-2"></i>分析報告
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_config') }}">
                                <i class="fas fa-cogs me-2"></i>系統配置
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('admin_doctors') }}">
                                <i class="fas fa-user-md me-2"></i>醫生資料庫
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_users') }}">
                                <i class="fas fa-users me-2"></i>用戶管理
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link" href="/" target="_blank">
                                <i class="fas fa-external-link-alt me-2"></i>查看網站
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_logout') }}">
                                <i class="fas fa-sign-out-alt me-2"></i>登出
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">醫生資料庫管理</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="addDoctor()">
                            <i class="fas fa-plus"></i> 新增醫生
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportDoctors()">
                            <i class="fas fa-download"></i> 匯出 CSV
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-view-mode active" onclick="switchView('table')" id="tableViewBtn">
                                <i class="fas fa-table me-1"></i>表格檢視
                            </button>
                            <button type="button" class="btn btn-view-mode" onclick="switchView('cards')" id="cardsViewBtn">
                                <i class="fas fa-th-large me-1"></i>卡片檢視
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Database Statistics -->
                <div class="db-stats">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3>{{ total_doctors|default(0) }}</h3>
                                <small>總醫生數</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3>{{ total_specialties|default(0) }}</h3>
                                <small>專科類別</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3>{{ bilingual_doctors|default(0) }}</h3>
                                <small>雙語醫生</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3>{{ with_contact|default(0) }}</h3>
                                <small>有聯絡資訊</small>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Search and Filters -->
                <div class="search-filters">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">搜尋醫生</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="輸入醫生姓名或專科...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">專科篩選</label>
                            <select class="form-select" id="specialtyFilter">
                                <option value="">所有專科</option>
                                {% for specialty in specialties %}
                                <option value="{{ specialty }}">{{ specialty }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">語言篩選</label>
                            <select class="form-select" id="languageFilter">
                                <option value="">所有語言</option>
                                <option value="中文">中文</option>
                                <option value="English">English</option>
                                <option value="雙語">雙語</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search me-1"></i>搜尋
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table View -->
                <div id="tableView" class="table-container">
                    <table id="doctorsTable" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>醫生姓名</th>
                                <th>專科</th>
                                <th>語言</th>
                                <th>資格</th>
                                <th>聯絡方式</th>
                                <th>診所地址</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doctor in doctors %}
                            <tr>
                                <td>
                                    {% if doctor.name_zh %}
                                        <strong>{{ doctor.name_zh }}</strong>
                                        {% if doctor.name_en %}
                                            <br><small class="text-muted">{{ doctor.name_en }}</small>
                                        {% endif %}
                                    {% elif doctor.name_en %}
                                        <strong>{{ doctor.name_en }}</strong>
                                    {% else %}
                                        <strong>{{ doctor.name or 'Unknown' }}</strong>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="specialty-badge">
                                        {{ doctor.specialty_zh or doctor.specialty_en or doctor.specialty }}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ doctor.languages_zh or doctor.languages_en or doctor.languages or '未提供' }}</small>
                                </td>
                                <td>
                                    <small>{{ (doctor.qualifications_zh or doctor.qualifications_en or doctor.qualifications or '未提供')[:50] }}{% if (doctor.qualifications_zh or doctor.qualifications_en or doctor.qualifications or '')|length > 50 %}...{% endif %}</small>
                                </td>
                                <td>
                                    {% if doctor.contact_numbers %}
                                        <small><i class="fas fa-phone me-1"></i>{{ doctor.contact_numbers.split(',')[0] }}</small>
                                    {% endif %}
                                    {% if doctor.email %}
                                        <br><small><i class="fas fa-envelope me-1"></i>{{ doctor.email }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ (doctor.clinic_addresses or '未提供')[:40] }}{% if (doctor.clinic_addresses or '')|length > 40 %}...{% endif %}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-sm btn-success me-1" onclick="editDoctor({{ doctor.id }})">
                                            <i class="fas fa-edit"></i> 編輯
                                        </button>
                                        <button class="btn btn-sm btn-info me-1" onclick="viewDoctor({{ doctor.id }})">
                                            <i class="fas fa-eye"></i> 檢視
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteDoctor({{ doctor.id }}, '{{ (doctor.name_zh or doctor.name_en or 'Unknown')|replace("'", "\\'") }}')">
                                            <i class="fas fa-trash"></i> 刪除
                                        </button>
                                        {% if doctor.profile_url %}
                                        <a href="{{ doctor.profile_url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-external-link-alt me-1"></i>檔案
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Cards View -->
                <div id="cardsView" style="display: none;">
                    <div class="row" id="cardsContainer">
                        <!-- Cards will be loaded dynamically via AJAX -->
                    </div>
                    <!-- Card Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div>
                            <span id="cardsPagingInfo">顯示 0 - 0 筆，共 0 筆</span>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="cardsPagination">
                                <!-- Pagination buttons will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Doctor Detail Modal -->
    <div class="modal fade" id="doctorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">醫生詳細資訊</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="doctorModalBody">
                    <!-- Doctor details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Doctor Edit Modal -->
    <div class="modal fade" id="editDoctorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">編輯醫生資料</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Modal Loading Indicator -->
                    <div id="modalLoading" class="modal-loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <p class="mt-2">載入專科資料中...</p>
                    </div>
                    
                    <form id="editDoctorForm">
                        <input type="hidden" id="editDoctorId" name="doctor_id">
                        
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mb-4" id="doctorFormTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                    <i class="fas fa-user me-2"></i>基本資訊
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                                    <i class="fas fa-phone me-2"></i>聯絡資訊
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="professional-tab" data-bs-toggle="tab" data-bs-target="#professional" type="button" role="tab">
                                    <i class="fas fa-certificate me-2"></i>專業資訊
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="doctorFormTabContent">
                            <!-- Basic Info Tab -->
                            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">醫生姓名 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editNameZh" name="name_zh" placeholder="請輸入醫生中文姓名" required>
                                            <div class="form-text">主要顯示名稱</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">English Name</label>
                                            <input type="text" class="form-control" id="editNameEn" name="name_en" placeholder="Doctor's English name">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">專科 <span class="text-danger">*</span></label>
                                            <select class="form-select" id="editSpecialtyZh" name="specialty_zh" required>
                                                <option value="">請選擇專科</option>
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Specialty (English)</label>
                                            <select class="form-select" id="editSpecialtyEn" name="specialty_en">
                                                <option value="">Select English specialty</option>
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">語言能力</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="langChinese" value="中文">
                                                <label class="form-check-label" for="langChinese">中文</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="langEnglish" value="English">
                                                <label class="form-check-label" for="langEnglish">English</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="langCantonese" value="廣東話">
                                                <label class="form-check-label" for="langCantonese">廣東話</label>
                                            </div>
                                            <input type="hidden" id="editLanguagesZh" name="languages_zh">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Languages (English)</label>
                                            <input type="text" class="form-control" id="editLanguagesEn" name="languages_en" placeholder="English, Mandarin, Cantonese">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contact Info Tab -->
                            <div class="tab-pane fade" id="contact" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">聯絡電話 <span class="text-danger">*</span></label>
                                            <input type="tel" class="form-control" id="editContactNumbers" name="contact_numbers" placeholder="例如: +852 1234 5678" required>
                                            <div class="form-text">可輸入多個電話號碼，用逗號分隔</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">電子郵件</label>
                                            <input type="email" class="form-control" id="editEmail" name="email" placeholder="doctor@example.com">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">個人檔案網址</label>
                                            <input type="url" class="form-control" id="editProfileUrl" name="profile_url" placeholder="https://">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">診所地址 <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="editClinicAddresses" name="clinic_addresses" rows="3" placeholder="請輸入完整診所地址" required></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">應診時間</label>
                                            <textarea class="form-control" id="editConsultationHours" name="consultation_hours" rows="3" placeholder="例如: 週一至五 9:00-17:00&#10;週六 9:00-13:00"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">診金</label>
                                            <div class="input-group">
                                                <span class="input-group-text">HK$</span>
                                                <input type="number" class="form-control" id="editConsultationFee" name="consultation_fee" placeholder="500">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Professional Info Tab -->
                            <div class="tab-pane fade" id="professional" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">資格認證 (中文)</label>
                                            <textarea class="form-control" id="editQualificationsZh" name="qualifications_zh" rows="4" placeholder="例如: 香港大學內外全科醫學士&#10;英國皇家內科醫學院院士"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">註冊號碼</label>
                                            <input type="text" class="form-control" id="editRegistrationNumber" name="registration_number" placeholder="例如: 12345">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Qualifications (English)</label>
                                            <textarea class="form-control" id="editQualificationsEn" name="qualifications_en" rows="4" placeholder="e.g. MBBS (HKU)&#10;MRCP (UK)"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">優先級</label>
                                            <select class="form-select" id="editPriorityFlag" name="priority_flag">
                                                <option value="0">一般</option>
                                                <option value="1">高優先級</option>
                                            </select>
                                            <div class="form-text">高優先級醫生會優先顯示</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveDoctorChanges()">儲存變更</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let doctorsTable;
        let currentView = 'table';
        
        $(document).ready(function() {
            // Initialize DataTable with server-side processing
            doctorsTable = $('#doctorsTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "/admin/doctors/paginated",
                    "type": "GET"
                },
                "columns": [
                    { 
                        "data": "name", 
                        "title": "姓名 <i class='fas fa-sort text-muted ms-1' style='cursor: pointer;' onclick='sortColumn(0)'></i>", 
                        "width": "18%"
                    },
                    { 
                        "data": "specialty", 
                        "title": "專科 <i class='fas fa-sort text-muted ms-1' style='cursor: pointer;' onclick='sortColumn(1)'></i>", 
                        "width": "18%"
                    },
                    { 
                        "data": "qualifications", 
                        "title": "資格 <i class='fas fa-sort text-muted ms-1' style='cursor: pointer;' onclick='sortColumn(2)'></i>", 
                        "width": "22%",
                        "render": function(data, type, row) {
                            if (type === 'display' && data && data.length > 50) {
                                return '<span title="' + data + '">' + data.substr(0, 50) + '...</span>';
                            }
                            return data || '';
                        }
                    },
                    { 
                        "data": "contact_numbers", 
                        "title": "聯絡電話 <i class='fas fa-sort text-muted ms-1' style='cursor: pointer;' onclick='sortColumn(3)'></i>", 
                        "width": "12%"
                    },
                    { 
                        "data": "clinic_addresses", 
                        "title": "診所地址 <i class='fas fa-sort text-muted ms-1' style='cursor: pointer;' onclick='sortColumn(4)'></i>", 
                        "width": "12%"
                    },
                    { 
                        "data": "priority_flag", 
                        "title": "優先 <i class='fas fa-sort text-muted ms-1' style='cursor: pointer;' onclick='sortColumn(5)'></i>",
                        "width": "6%",
                        "render": function(data, type, row) {
                            return data == 1 ? '<span class="badge bg-warning">優先</span>' : '';
                        }
                    },
                    { 
                        "data": "id", 
                        "title": "操作",
                        "width": "12%",
                        "orderable": false,
                        "render": function(data, type, row) {
                            return `
                                <div class="btn-group-vertical btn-group-sm" style="width: 100%;">
                                    <button class="btn btn-xs btn-success mb-1" onclick="editDoctor(${data})" style="font-size: 0.7rem; padding: 2px 4px;">
                                        <i class="fas fa-edit"></i> 編輯
                                    </button>
                                    <button class="btn btn-xs btn-info mb-1" onclick="viewDoctor(${data})" style="font-size: 0.7rem; padding: 2px 4px;">
                                        <i class="fas fa-eye"></i> 檢視
                                    </button>
                                    <button class="btn btn-xs btn-danger" onclick="deleteDoctor(${data}, '${row.name || 'Unknown'}')" style="font-size: 0.7rem; padding: 2px 4px;">
                                        <i class="fas fa-trash"></i> 刪除
                                    </button>
                                </div>
                            `;
                        }
                    }
                ],
                "pageLength": 25,
                "order": [[ 0, "asc" ]],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/zh_Hant.json"
                },
                "destroy": true,
                "responsive": true,
                "dom": '<"row"<"col-sm-12"tr>>' +
                       '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
            });
            
            // Search functionality
            $('#searchInput').on('keyup', function() {
                doctorsTable.search(this.value).draw();
            });
            
            // Specialty filter
            $('#specialtyFilter').on('change', function() {
                var specialty = this.value;
                if (specialty === '') {
                    doctorsTable.column(1).search('').draw();
                } else {
                    doctorsTable.column(1).search(specialty).draw();
                }
            });
        });
        
        // View switching function
        function switchView(view) {
            currentView = view;
            if (view === 'table') {
                document.getElementById('tableView').style.display = 'block';
                document.getElementById('cardsView').style.display = 'none';
                document.getElementById('tableViewBtn').classList.add('active');
                document.getElementById('cardsViewBtn').classList.remove('active');
            } else {
                document.getElementById('tableView').style.display = 'none';
                document.getElementById('cardsView').style.display = 'block';
                document.getElementById('tableViewBtn').classList.remove('active');
                document.getElementById('cardsViewBtn').classList.add('active');
                loadCardsView();
            }
        }

        // Card view pagination variables
        let currentCardPage = 1;
        const cardsPerPage = 12;
        let totalCardRecords = 0;

        // Load cards view with AJAX data and pagination
        function loadCardsView(page = 1) {
            currentCardPage = page;
            const start = (page - 1) * cardsPerPage;
            
            fetch(`/admin/doctors/paginated?start=${start}&length=${cardsPerPage}`)
                .then(response => response.json())
                .then(result => {
                    const cardsContainer = document.getElementById('cardsContainer');
                    cardsContainer.innerHTML = '';
                    totalCardRecords = result.recordsTotal;
                    
                    let cardsHtml = '';
                    result.data.forEach(doctor => {
                        cardsHtml += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="doctor-card card h-100">
                                    <div class="card-body d-flex flex-column">
                                        <h6 class="card-title">
                                            ${doctor.name || 'Unknown'}
                                        </h6>
                                        <p class="card-text">
                                            <span class="specialty-badge">
                                                ${doctor.specialty || ''}
                                            </span>
                                        </p>
                                        ${doctor.contact_numbers ? `
                                        <p class="card-text">
                                            <small><i class="fas fa-phone me-1"></i>${doctor.contact_numbers.split(',')[0]}</small>
                                        </p>
                                        ` : ''}
                                        <div class="d-flex justify-content-between mt-auto">
                                            <button class="btn btn-sm btn-success me-1" onclick="editDoctor(${doctor.id})">
                                                <i class="fas fa-edit"></i> 編輯
                                            </button>
                                            <button class="btn btn-sm btn-info me-1" onclick="viewDoctor(${doctor.id})">
                                                <i class="fas fa-eye"></i> 檢視
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteDoctor(${doctor.id}, '${doctor.name || 'Unknown'}')">
                                                <i class="fas fa-trash"></i> 刪除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    cardsContainer.innerHTML = cardsHtml;
                    
                    // Update pagination info and controls
                    updateCardsPagination(result);
                })
                .catch(error => {
                    console.error('Error loading cards:', error);
                    document.getElementById('cardsContainer').innerHTML = '<div class="col-12"><p class="text-center">載入卡片資料時發生錯誤</p></div>';
                });
        }

        // Update cards pagination controls
        function updateCardsPagination(result) {
            const start = (currentCardPage - 1) * cardsPerPage + 1;
            const end = Math.min(start + result.data.length - 1, result.recordsTotal);
            const total = result.recordsTotal;
            
            // Update info text
            document.getElementById('cardsPagingInfo').textContent = `顯示 ${start} - ${end} 筆，共 ${total} 筆`;
            
            // Generate pagination buttons
            const totalPages = Math.ceil(total / cardsPerPage);
            const pagination = document.getElementById('cardsPagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentCardPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadCardsView(${currentCardPage - 1}); return false;">上一頁</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentCardPage - 2);
            const endPage = Math.min(totalPages, currentCardPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentCardPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadCardsView(${i}); return false;">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentCardPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadCardsView(${currentCardPage + 1}); return false;">下一頁</a>`;
            pagination.appendChild(nextLi);
        }

        // Sort column function
        function sortColumn(columnIndex) {
            const currentOrder = doctorsTable.order();
            let newOrder = 'asc';
            
            // If already sorting by this column, toggle direction
            if (currentOrder.length > 0 && currentOrder[0][0] === columnIndex) {
                newOrder = currentOrder[0][1] === 'asc' ? 'desc' : 'asc';
            }
            
            doctorsTable.order([columnIndex, newOrder]).draw();
            
            // Update sort icons
            updateSortIcons(columnIndex, newOrder);
        }

        // Update sort icons in column headers
        function updateSortIcons(activeColumn, direction) {
            // Reset all sort icons
            document.querySelectorAll('th i.fas').forEach(icon => {
                if (icon.classList.contains('fa-sort') || 
                    icon.classList.contains('fa-sort-up') || 
                    icon.classList.contains('fa-sort-down')) {
                    icon.className = 'fas fa-sort text-muted ms-1';
                }
            });
            
            // Update active column icon
            const headers = document.querySelectorAll('th');
            if (headers[activeColumn]) {
                const icon = headers[activeColumn].querySelector('i.fas');
                if (icon) {
                    icon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} text-primary ms-1`;
                }
            }
        }
        
        function changePageSize(size) {
            if (size == -1) {
                doctorsTable.page.len(-1).draw();
            } else {
                doctorsTable.page.len(parseInt(size)).draw();
            }
        }
        
        function applyFilters() {
            var searchTerm = document.getElementById('searchInput').value;
            var specialty = document.getElementById('specialtyFilter').value;
            
            doctorsTable.search(searchTerm);
            if (specialty) {
                doctorsTable.column(1).search(specialty);
            }
            doctorsTable.draw();
        }
        
        function deleteDoctor(doctorId, doctorName) {
            if (confirm(`確定要刪除醫生「${doctorName}」嗎？此操作無法復原。`)) {
                fetch(`/admin/doctors/${doctorId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    console.log('Delete response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response:', text);
                            throw new Error(`HTTP error! status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        alert('醫生已成功刪除！');
                        location.reload();
                    } else {
                        alert('刪除失敗：' + (result.error || '未知錯誤'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting doctor:', error);
                    alert('刪除醫生時發生錯誤');
                });
            }
        }
        
        async function addDoctor() {
            // Show modal loading
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('editDoctorModal'));
            modal.show();
            
            // Show loading indicator
            document.getElementById('modalLoading').style.display = 'block';
            document.getElementById('editDoctorForm').style.display = 'none';
            
            // Clear form and show modal for adding new doctor
            document.getElementById('editDoctorId').value = '';
            document.getElementById('editNameZh').value = '';
            document.getElementById('editNameEn').value = '';
            document.getElementById('editSpecialtyZh').value = '';
            document.getElementById('editSpecialtyEn').value = '';
            document.getElementById('editQualificationsZh').value = '';
            document.getElementById('editQualificationsEn').value = '';
            document.getElementById('editLanguagesZh').value = '';
            document.getElementById('editLanguagesEn').value = '';
            document.getElementById('editContactNumbers').value = '';
            document.getElementById('editEmail').value = '';
            document.getElementById('editClinicAddresses').value = '';
            document.getElementById('editConsultationHours').value = '';
            document.getElementById('editConsultationFee').value = '';
            document.getElementById('editProfileUrl').value = '';
            document.getElementById('editRegistrationNumber').value = '';
            document.getElementById('editPriorityFlag').value = '0';
            
            // Update modal title
            document.querySelector('#editDoctorModal .modal-title').textContent = '新增醫生';
            
            // Load specialties before showing modal
            await loadSpecialties();
            
            // Hide loading and show form
            document.getElementById('modalLoading').style.display = 'none';
            document.getElementById('editDoctorForm').style.display = 'block';
        }
        
        async function editDoctor(doctorId) {
            console.log('Edit doctor called with ID:', doctorId);
            
            // Validate doctorId first
            if (!doctorId) {
                alert('錯誤：無效的醫生ID');
                return;
            }
            
            // Show modal with loading first
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('editDoctorModal'));
            modal.show();
            
            // Show loading indicator
            document.getElementById('modalLoading').style.display = 'block';
            document.getElementById('editDoctorForm').style.display = 'none';
            
            // Set doctor ID immediately
            document.getElementById('editDoctorId').value = doctorId;
            
            // Load doctor data and show edit modal
            fetch(`/admin/doctors/${doctorId}`)
                .then(response => {
                    console.log('Fetch response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(async data => {
                    console.log('Doctor data received:', data);
                    if (!data || data.error) {
                        alert('載入醫生資料失敗：' + (data?.error || '未知錯誤'));
                        return;
                    }
                    
                    // Load specialties first
                    await loadSpecialties();
                    
                    // Populate edit form
                    document.getElementById('editDoctorId').value = data.id;
                    document.getElementById('editNameZh').value = data.name_zh || '';
                    document.getElementById('editNameEn').value = data.name_en || '';
                    document.getElementById('editSpecialtyZh').value = data.specialty_zh || '';
                    document.getElementById('editSpecialtyEn').value = data.specialty_en || '';
                    document.getElementById('editQualificationsZh').value = data.qualifications_zh || '';
                    document.getElementById('editQualificationsEn').value = data.qualifications_en || '';
                    document.getElementById('editLanguagesZh').value = data.languages_zh || '';
                    document.getElementById('editLanguagesEn').value = data.languages_en || '';
                    document.getElementById('editContactNumbers').value = data.contact_numbers || '';
                    document.getElementById('editEmail').value = data.email || '';
                    document.getElementById('editClinicAddresses').value = data.clinic_addresses || '';
                    document.getElementById('editConsultationHours').value = data.consultation_hours || '';
                    document.getElementById('editConsultationFee').value = data.consultation_fee || '';
                    document.getElementById('editProfileUrl').value = data.profile_url || '';
                    document.getElementById('editRegistrationNumber').value = data.registration_number || '';
                    document.getElementById('editPriorityFlag').value = data.priority_flag || '0';
                    
                    // Update language checkboxes
                    updateLanguageCheckboxes(data.languages_zh || '');
                    
                    // Update modal title
                    document.querySelector('#editDoctorModal .modal-title').textContent = '編輯醫生資料';
                    
                    // Hide loading and show form
                    document.getElementById('modalLoading').style.display = 'none';
                    document.getElementById('editDoctorForm').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading doctor data:', error);
                    alert('載入醫生資料時發生錯誤');
                });
        }
        
        function viewDoctor(doctorId) {
            // Load doctor details via AJAX
            fetch(`/admin/doctors/${doctorId}`)
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('doctorModalBody');
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>基本資訊</h6>
                                <p><strong>中文姓名:</strong> ${data.name_zh || '未提供'}</p>
                                <p><strong>英文姓名:</strong> ${data.name_en || '未提供'}</p>
                                <p><strong>中文專科:</strong> ${data.specialty_zh || '未提供'}</p>
                                <p><strong>英文專科:</strong> ${data.specialty_en || '未提供'}</p>
                                <p><strong>語言:</strong> ${data.languages_zh || data.languages_en || '未提供'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>聯絡資訊</h6>
                                <p><strong>電話:</strong> ${data.contact_numbers || '未提供'}</p>
                                <p><strong>電郵:</strong> ${data.email || '未提供'}</p>
                                <p><strong>診所地址:</strong> ${data.clinic_addresses || '未提供'}</p>
                                <p><strong>應診時間:</strong> ${data.consultation_hours || '未提供'}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>專業資格</h6>
                                <p>${data.qualifications_zh || data.qualifications_en || '未提供'}</p>
                            </div>
                        </div>
                        ${data.profile_url ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <a href="${data.profile_url}" target="_blank" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt me-1"></i>查看完整檔案
                                </a>
                            </div>
                        </div>
                        ` : ''}
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('doctorModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading doctor details:', error);
                    alert('載入醫生詳情時發生錯誤');
                });
        }
        
        function refreshData() {
            location.reload();
        }
        
        function exportDoctors() {
            window.open('/admin/database/export-doctors', '_blank');
        }
        
        function exportData() {
            window.open('/admin/database/export-doctors', '_blank');
        }
        
        
        function saveDoctorChanges() {
            const formData = new FormData(document.getElementById('editDoctorForm'));
            const doctorId = document.getElementById('editDoctorId').value;
            
            // Convert FormData to JSON
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            console.log('Save data:', data);
            
            // Determine if this is a new doctor (no ID) or existing doctor (has ID)
            const isNewDoctor = !doctorId || doctorId.trim() === '';
            const url = isNewDoctor ? '/admin/doctors/add' : `/admin/doctors/${doctorId}/update`;
            
            console.log('Is new doctor:', isNewDoctor, 'URL:', url);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response URL:', response.url);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    const message = isNewDoctor ? '醫生已成功新增！' : '醫生資料已成功更新！';
                    alert(message);
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editDoctorModal'));
                    modal.hide();
                    // Refresh page to show updated data
                    location.reload();
                } else {
                    alert('保存失敗：' + (result.error || '未知錯誤'));
                }
            })
            .catch(error => {
                console.error('Error saving doctor data:', error);
                alert('儲存醫生資料時發生錯誤');
            });
        }

        // Language checkbox handling
        function updateLanguageCheckboxes(languagesText) {
            // Clear all checkboxes first
            document.getElementById('langChinese').checked = false;
            document.getElementById('langEnglish').checked = false;
            document.getElementById('langCantonese').checked = false;
            
            if (languagesText) {
                const languages = languagesText.toLowerCase();
                if (languages.includes('中文') || languages.includes('mandarin')) {
                    document.getElementById('langChinese').checked = true;
                }
                if (languages.includes('english') || languages.includes('英文')) {
                    document.getElementById('langEnglish').checked = true;
                }
                if (languages.includes('廣東話') || languages.includes('cantonese')) {
                    document.getElementById('langCantonese').checked = true;
                }
            }
        }

        function updateLanguageField() {
            const checkboxes = ['langChinese', 'langEnglish', 'langCantonese'];
            const selectedLanguages = [];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox.checked) {
                    selectedLanguages.push(checkbox.value);
                }
            });
            
            document.getElementById('editLanguagesZh').value = selectedLanguages.join(', ');
        }

        // Global variables for specialty mapping
        let specialtyMap = {};
        let reverseSpecialtyMap = {};

        // Load specialties from database (cached)
        let specialtiesLoaded = false;
        async function loadSpecialties() {
            if (specialtiesLoaded) return; // Prevent duplicate loading
            
            try {
                const response = await fetch('/admin/specialties');
                const data = await response.json();
                
                if (data.chinese && data.english) {
                    // Populate Chinese specialty dropdown
                    const chineseSelect = document.getElementById('editSpecialtyZh');
                    if (chineseSelect && chineseSelect.options.length <= 1) {
                        chineseSelect.innerHTML = '<option value="">請選擇專科</option>';
                        data.chinese.forEach(specialty => {
                            const option = document.createElement('option');
                            option.value = specialty;
                            option.textContent = specialty;
                            chineseSelect.appendChild(option);
                        });
                    }

                    // Populate English specialty dropdown
                    const englishSelect = document.getElementById('editSpecialtyEn');
                    if (englishSelect && englishSelect.options.length <= 1) {
                        englishSelect.innerHTML = '<option value="">Select English specialty</option>';
                        data.english.forEach(specialty => {
                            const option = document.createElement('option');
                            option.value = specialty;
                            option.textContent = specialty;
                            englishSelect.appendChild(option);
                        });
                    }

                    // Create mapping by matching existing doctor records
                    if (Object.keys(specialtyMap).length === 0) {
                        await createSpecialtyMapping();
                    }
                    specialtiesLoaded = true;
                }
            } catch (error) {
                console.error('Error loading specialties:', error);
            }
        }

        // Create specialty mapping by analyzing existing doctor records
        async function createSpecialtyMapping() {
            try {
                const response = await fetch('/admin/doctors/data');
                if (response.ok) {
                    const doctors = await response.json();
                    
                    // Build mapping from existing doctor data
                    doctors.forEach(doctor => {
                        if (doctor.specialty_zh && doctor.specialty_en) {
                            specialtyMap[doctor.specialty_zh] = doctor.specialty_en;
                            reverseSpecialtyMap[doctor.specialty_en] = doctor.specialty_zh;
                        }
                    });
                }
            } catch (error) {
                console.error('Error creating specialty mapping:', error);
                // Fallback to basic mapping if needed
                createFallbackMapping();
            }
        }

        // Fallback mapping for common specialties
        function createFallbackMapping() {
            const basicMap = {
                '內科': 'Internal Medicine',
                '外科': 'Surgery', 
                '小兒科': 'Pediatrics',
                '婦產科': 'Obstetrics and Gynecology',
                '骨科': 'Orthopedics',
                '皮膚科': 'Dermatology',
                '眼科': 'Ophthalmology',
                '耳鼻喉科': 'Otolaryngology',
                '精神科': 'Psychiatry',
                '神經科': 'Neurology',
                '心臟科': 'Cardiology',
                '急診科': 'Emergency Medicine',
                '全科醫生': 'General Practitioner'
            };
            
            Object.assign(specialtyMap, basicMap);
            Object.keys(basicMap).forEach(chinese => {
                reverseSpecialtyMap[basicMap[chinese]] = chinese;
            });
        }

        // Show page loading overlay
        function showPageLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        // Hide page loading overlay
        function hidePageLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Add event listeners for language checkboxes
        let eventListenersAdded = false;
        document.addEventListener('DOMContentLoaded', function() {
            if (eventListenersAdded) return; // Prevent duplicate listeners
            
            // Show loading while page initializes
            showPageLoading();
            
            // Load specialties on page load
            loadSpecialties().then(() => {
                // Hide loading once everything is ready
                hidePageLoading();
            }).catch(() => {
                hidePageLoading();
            });
            
            ['langChinese', 'langEnglish', 'langCantonese'].forEach(id => {
                const element = document.getElementById(id);
                if (element && !element.hasAttribute('data-listener-added')) {
                    element.addEventListener('change', updateLanguageField);
                    element.setAttribute('data-listener-added', 'true');
                }
            });
            eventListenersAdded = true;

            // Form validation
            const form = document.getElementById('editDoctorForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Basic validation
                const requiredFields = ['editNameZh', 'editSpecialtyZh', 'editContactNumbers', 'editClinicAddresses'];
                let isValid = true;
                
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
                
                if (isValid) {
                    saveDoctorChanges();
                } else {
                    // Switch to the first tab with errors
                    const basicTab = document.getElementById('basic-tab');
                    const contactTab = document.getElementById('contact-tab');
                    
                    if (!document.getElementById('editNameZh').value.trim() || 
                        !document.getElementById('editSpecialtyZh').value.trim()) {
                        basicTab.click();
                    } else if (!document.getElementById('editContactNumbers').value.trim() || 
                               !document.getElementById('editClinicAddresses').value.trim()) {
                        contactTab.click();
                    }
                    
                    alert('請填寫所有必填欄位（標有 * 的欄位）');
                }
            });

            // Auto-update English specialty when Chinese is selected
            document.getElementById('editSpecialtyZh').addEventListener('change', function() {
                const selectedSpecialty = this.value;
                const englishField = document.getElementById('editSpecialtyEn');
                if (specialtyMap[selectedSpecialty]) {
                    englishField.value = specialtyMap[selectedSpecialty];
                }
            });

            // Auto-update Chinese specialty when English is selected
            document.getElementById('editSpecialtyEn').addEventListener('change', function() {
                const selectedSpecialty = this.value;
                const chineseField = document.getElementById('editSpecialtyZh');
                if (reverseSpecialtyMap[selectedSpecialty]) {
                    chineseField.value = reverseSpecialtyMap[selectedSpecialty];
                }
            });
        });
    </script>
</body>
</html>
