<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加雙重認證設備 - Doctor AI Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .setup-container {
            max-width: 600px;
            margin: 2rem auto;
        }
        .qr-code-container {
            text-align: center;
            padding: 2rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        .qr-code-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .secret-key {
            font-family: 'Courier New', monospace;
            background-color: #e9ecef;
            padding: 0.75rem;
            border-radius: 4px;
            word-break: break-all;
            font-size: 0.9rem;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        .step.completed .step-number {
            background-color: #198754;
        }
        .step.inactive .step-number {
            background-color: #6c757d;
        }
        .instruction-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .app-icons {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1.5rem 0;
        }
        .app-icon {
            text-align: center;
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s;
        }
        .app-icon:hover {
            transform: scale(1.05);
            color: inherit;
        }
        .app-icon i {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .google-auth { color: #4285f4; }
        .microsoft-auth { color: #00a1f1; }
        .authy { color: #ec1c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="setup-container">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-mobile-alt me-2"></i>添加雙重認證設備
                </h1>
                <p class="text-muted">為您的帳戶添加新的雙重認證設備</p>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <span>設備命名</span>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <span>掃描QR碼</span>
                </div>
                <div class="step inactive">
                    <div class="step-number">3</div>
                    <span>驗證設置</span>
                </div>
            </div>

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Setup Instructions -->
            <div class="instruction-card">
                <h5><i class="fas fa-info-circle me-2 text-primary"></i>設置說明</h5>
                <ol>
                    <li class="mb-2">在您的手機上下載並安裝雙重認證應用程式</li>
                    <li class="mb-2">使用應用程式掃描下方的QR碼</li>
                    <li class="mb-2">輸入應用程式顯示的6位數驗證碼</li>
                    <li>完成設置</li>
                </ol>
            </div>

            <!-- Recommended Apps -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-download me-2"></i>推薦的認證應用程式</h6>
                </div>
                <div class="card-body">
                    <div class="app-icons">
                        <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" 
                           target="_blank" class="app-icon google-auth">
                            <i class="fab fa-google"></i>
                            <div>Google<br>Authenticator</div>
                        </a>
                        <a href="https://www.microsoft.com/en-us/security/mobile-authenticator-app" 
                           target="_blank" class="app-icon microsoft-auth">
                            <i class="fab fa-microsoft"></i>
                            <div>Microsoft<br>Authenticator</div>
                        </a>
                        <a href="https://authy.com/download/" 
                           target="_blank" class="app-icon authy">
                            <i class="fas fa-shield-alt"></i>
                            <div>Authy</div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Device Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <h6><i class="fas fa-tag me-2"></i>設備信息</h6>
                    <div class="row">
                        <div class="col-sm-4"><strong>設備名稱:</strong></div>
                        <div class="col-sm-8">{{ device_name }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>用戶:</strong></div>
                        <div class="col-sm-8">{{ username }}</div>
                    </div>
                </div>
            </div>

            <!-- QR Code -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-qrcode me-2"></i>掃描QR碼</h6>
                </div>
                <div class="card-body">
                    <div class="qr-code-container">
                        <img src="{{ qr_code }}" alt="QR Code" class="img-fluid">
                        <p class="mt-3 mb-0 text-muted">使用您的認證應用程式掃描此QR碼</p>
                    </div>
                </div>
            </div>

            <!-- Manual Entry -->
            <div class="card mb-4">
                <div class="card-header">
                    <button class="btn btn-link p-0 text-decoration-none" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#manualEntry">
                        <i class="fas fa-keyboard me-2"></i>無法掃描？手動輸入密鑰
                    </button>
                </div>
                <div class="collapse" id="manualEntry">
                    <div class="card-body">
                        <p class="mb-2">如果無法掃描QR碼，請在您的認證應用程式中手動輸入以下密鑰：</p>
                        <div class="secret-key">{{ secret }}</div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="copySecret()">
                            <i class="fas fa-copy me-1"></i>複製密鑰
                        </button>
                    </div>
                </div>
            </div>

            <!-- Verification Form -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>驗證設置</h6>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="device_name" value="{{ device_name }}">
                        <div class="mb-3">
                            <label for="token" class="form-label">驗證碼</label>
                            <input type="text" class="form-control form-control-lg text-center" 
                                   id="token" name="token" placeholder="000000" 
                                   maxlength="6" pattern="[0-9]{6}" required
                                   style="font-family: 'Courier New', monospace; font-size: 1.5rem; letter-spacing: 0.5rem;">
                            <div class="form-text">
                                請輸入您的認證應用程式顯示的6位數驗證碼
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('manage_2fa_devices') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>返回
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>完成設置
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <button class="btn btn-link p-0 text-decoration-none" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#helpSection">
                        <i class="fas fa-question-circle me-2"></i>需要幫助？
                    </button>
                </div>
                <div class="collapse" id="helpSection">
                    <div class="card-body">
                        <h6>常見問題：</h6>
                        <div class="accordion" id="faqAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#faq1">
                                        驗證碼不正確怎麼辦？
                                    </button>
                                </h2>
                                <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>確保您的手機時間與服務器時間同步</li>
                                            <li>等待新的驗證碼生成（每30秒更新一次）</li>
                                            <li>檢查是否正確掃描了QR碼</li>
                                            <li>嘗試手動輸入密鑰</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#faq2">
                                        無法掃描QR碼？
                                    </button>
                                </h2>
                                <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        您可以點擊上方的"手動輸入密鑰"選項，然後在您的認證應用程式中手動添加帳戶並輸入提供的密鑰。
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-format token input
        document.getElementById('token').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            e.target.value = value;
        });

        // Copy secret key function
        function copySecret() {
            const secretText = '{{ secret }}';
            navigator.clipboard.writeText(secretText).then(function() {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i>已複製';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                
                setTimeout(function() {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(function(err) {
                console.error('複製失敗: ', err);
                alert('複製失敗，請手動選擇並複製密鑰');
            });
        }

        // Auto-submit form when 6 digits are entered
        document.getElementById('token').addEventListener('input', function(e) {
            if (e.target.value.length === 6) {
                // Small delay to allow user to see the complete code
                setTimeout(function() {
                    if (document.getElementById('token').value.length === 6) {
                        // Optional: auto-submit after a short delay
                        // document.querySelector('form').submit();
                    }
                }, 500);
            }
        });

        // Focus on token input when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('token').focus();
        });
    </script>
</body>
</html>
